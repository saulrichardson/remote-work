-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/saul/Dropbox/Remote Work Startups/main/spec/stata/log/user_
> productivity_initial_precovid.log
  log type:  text
 opened on:   3 Nov 2025, 10:32:05

. 
. // 0) Setup environment
. local __bootstrap "_bootstrap.do"

. if !fileexists("`__bootstrap'") local __bootstrap "spec/stata/_bootstrap.do"

. if !fileexists("`__bootstrap'") local __bootstrap "../spec/stata/_bootstrap.d
> o"

. if !fileexists("`__bootstrap'") {
.     di as error "Unable to locate _bootstrap.do. Run from project root or spe
> c/stata."
.     exit 601
. }

. do "`__bootstrap'"

. * ----------------------------------------------------------------------
. * spec/_bootstrap.do — Resolve project paths robustly
. * Include this at the top of every spec before referencing $PROJECT_ROOT
. * ----------------------------------------------------------------------
. 
. capture confirm global PROJECT_ROOT

. if _rc {
.     * First try environment variable so batch jobs can override paths
.     local env_root: env PROJECT_ROOT
.     if "`env_root'" == "" {
.         * Backwards compatibility for legacy STATAROOT env var
.         local env_root: env STATAROOT
.     }
.     if "`env_root'" != "" {
.         global PROJECT_ROOT "`env_root'"
.     }
.     else {
.         * Derive from the current script location (this bootstrap file)
.         local __bootstrap_self "`c(filename)'"
.         if "`__bootstrap_self'" == "" {
.             * When invoked interactively, fall back to current directory
.             local __bootstrap_self "`c(pwd)'/_bootstrap.do"
.         }
. 
.         capture mata: mata drop __trim_trailing_sep()
.         capture mata: mata drop __parent_dir()
.         capture mata: mata drop __find_project_root()
. 
.         mata:
------------------------------------------------- mata (type end to exit) -----
:         function __trim_trailing_sep(string scalar path) {
>             string scalar backslash
>             backslash = char(92)
>             real scalar len
>             len = strlen(path)
>             while (len > 1) {
>                 string scalar last
>                 last = substr(path, len, 1)
>                 if (last == "/" | last == backslash) {
>                     /* preserve drive roots like C:\ */
>                     if (len == 3 & substr(path, 2, 1) == ":") {
>                         break
>                     }
>                     path = substr(path, 1, len - 1)
>                     len  = len - 1
>                 }
>                 else {
>                     break
>                 }
>             }
>             return(path)
>         }

: 
:         function __parent_dir(string scalar path) {
>             string scalar backslash
>             real scalar i, len
>             backslash = char(92)
>             string scalar clean, ch
> 
>             clean = __trim_trailing_sep(path)
>             len   = strlen(clean)
>             if (len == 0) return("")
> 
>             for (i = len; i >= 1; i--) {
>                 ch = substr(clean, i, 1)
>                 if (ch == "/" | ch == backslash) {
>                     if (i == 1) return(substr(clean, 1, 1))
>                     if (i == 3 & substr(clean, 2, 1) == ":") return(substr(cl
> ean, 1, 3))
>                     return(substr(clean, 1, i - 1))
>                 }
>             }
>             return("")
>         }

: 
:         function __find_project_root(string scalar start) {
>             string scalar here
>             here = __trim_trailing_sep(start)
>             while (here != "") {
>                 if (direxists(here + "/.git") | fileexists(here + "/README.md
> ")) {
>                     return(here)
>                 }
>                 here = __parent_dir(here)
>             }
>             return("")
>         }

:         end
-------------------------------------------------------------------------------
. 
.         mata: st_local("__bootstrap_self", "`__bootstrap_self'")
.         mata: st_local("__spec_dir", __parent_dir(st_local("__bootstrap_self"
> )))
.         mata: st_local("__proj_root", __find_project_root(st_local("__spec_di
> r")))
.         if "`__proj_root'" == "" {
.             di as error "Unable to locate project root. Set PROJECT_ROOT env 
> var before running."
.             exit 198
.         }
.         global PROJECT_ROOT "`__proj_root'"
.     }
. }

. 
. * Derive commonly used paths from the resolved root
. if "$PROJECT_ROOT" == "" {
.     di as error "PROJECT_ROOT is empty after bootstrap."
.     exit 198
. }

. 
. local __sep "/"

. if strpos("`c(os)'","Windows") local __sep "\"

. 
. global RAW_DATA        "$PROJECT_ROOT`__sep'data/raw"

. global PROCESSED_DATA  "$PROJECT_ROOT`__sep'data/processed"

. global RAW_RESULTS     "$PROJECT_ROOT`__sep'results/raw"

. global FINAL_TEX       "$PROJECT_ROOT`__sep'results/final/tex"

. global FINAL_FIGURES   "$PROJECT_ROOT`__sep'results/final/figures"

. 
. mata: mata drop __find_project_root()

. mata: mata drop __parent_dir()

. mata: mata drop __trim_trailing_sep()

. 
. 
. * Backwards-compatible aliases
. global results        "$RAW_RESULTS"

. global processed_data "$PROCESSED_DATA"

. global data_processed "$PROCESSED_DATA"

. global clean_results  "$FINAL_TEX"

. 
end of do-file

. 
. // 1) Load worker‐level panel
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. // 2) Prepare output dir & reset any old postfile
. *--------------------------------------------------------------------------*
. * Output directory is *always* suffixed with the panel variant so each run is
. * explicit about the underlying sample (e.g., "user_productivity_initial_bala
> nced").
. *--------------------------------------------------------------------------*
. 
. local result_dir  "$results/`specname'"

. capture mkdir "`result_dir'"

. 
. capture postclose handle

. tempfile out

. *--- postfile header (main results) -----------------------------------------
> --
. postfile handle ///
>     str8   model_type ///
>     str40  outcome     ///
>     str40  param       ///
>     double coef se pval pre_mean ///
>     double rkf nobs     ///
>     using `out', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//St16345.000001 not
    found)

. 
. 
. *------------------------------------------------------------------
. *  First-stage results → first_stage_fstats.csv
. *------------------------------------------------------------------
. tempfile out_fs

. capture postclose handle_fs

. postfile handle_fs ///
>     str8   endovar            ///
>     str40  param              /// 
>     double coef se pval       ///
>     double partialF rkf nobs  ///
>     using `out_fs', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//St16345.000002 not
    found)

.         
. // 3) Loop over outcomes
. local outcomes total_contributions_q100 restricted_contributions_q100 

. local fs_done 0

. 
. foreach y of local outcomes {
  2.     di as text "→ Processing outcome: `y'"
  3. 
.     summarize `y' if covid == 0, meanonly
  4.     local pre_mean = r(mean)
  5. 
.     // ----- OLS -----
.     reghdfe `y' var3 var4, absorb(user_id firm_id yh) ///
>         vce(cluster user_id)
  6.                 
.         local N = e(N) 
  7.         
.     foreach p in var3 var4 {
  8.         local b    = _b[`p']
  9.         local se   = _se[`p']
 10.         local t    = `b'/`se'
 11.         local pval = 2*ttail(e(df_r), abs(`t'))
 12.                 *--- inside the OLS loop ---------------------------------
> ---------------------
.         post handle ("OLS") ("`y'") ("`p'") ///
>                                         (`b') (`se') (`pval') (`pre_mean') //
> /
>                                         (.) (`N')                 // dot for 
> rkf, then nobs
 13.     }
 14. 
.     // ----- IV (2nd‐stage) -----
.     ivreghdfe ///
>         `y' (var3 = var6) var4, ///
>         absorb(user_id firm_id yh) vce(cluster user_id) savefirst
 15.                 
.     local rkf = e(rkf)
 16.         local N = e(N) 
 17.         
.     foreach p in var3 var4 {
 18.         local b    = _b[`p']
 19.         local se   = _se[`p']
 20.         local t    = `b'/`se'
 21.         local pval = 2*ttail(e(df_r), abs(`t'))
 22.                 *--- inside the IV loop ----------------------------------
> ---------------------
.         post handle ("IV") ("`y'") ("`p'") ///
>                                         (`b') (`se') (`pval') (`pre_mean') //
> /
>                                         (`rkf') (`N')            // rkf, then
>  nobs
 23.     }
 24. 
.         if !`fs_done' {
 25.                 
.                 matrix FS = e(first)
 26.         local F3 = FS[4,1]
 27. 
.                 /* -------- var3 first stage --------------------------------
>  */
.                 estimates restore _ivreg2_var3
 28.                 local N_fs = e(N)
 29.                 foreach p in var6 var4 {
 30.                         local b    = _b[`p']
 31.                         local se   = _se[`p']
 32.                         local t    = `b'/`se'
 33.                         local pval = 2*ttail(e(df_r), abs(`t'))
 34. 
.                         post handle_fs ("var3") ("`p'") ///
>                                                         (`b') (`se') (`pval')
>  ///
>                                                         (`F3') (`rkf') (`N_fs
> ')
 35.                 }
 36. 
. 
.                 local fs_done 1
 37.         }
 38. }
→ Processing outcome: total_contributions_q100
(dropped 1443 singleton observations)
(MWFE estimator converged in 80 iterations)

HDFE Linear regression                            Number of obs   =    229,862
Absorbing 3 HDFE groups                           F(   2,  35788) =       8.83
Statistics robust to heteroskedasticity           Prob > F        =     0.0001
                                                  R-squared       =     0.6838
                                                  Adj R-squared   =     0.6213
                                                  Within R-sq.    =     0.0002
Number of clusters (user_id) =     35,789         Root MSE        =    18.4426

                           (Std. err. adjusted for 35,789 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |   -.277141   .4449311    -0.62   0.533    -1.149219    .5949374
        var4 |  -1.286031     .33232    -3.87   0.000    -1.937389   -.6346741
       _cons |   49.90842   .1359494   367.11   0.000     49.64196    50.17489
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     35789       35789           0    *|
     firm_id |      2151           1        2150     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
(dropped 1443 singleton observations)
(MWFE estimator converged in 80 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          2  First-stage regression: var3
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35789                Number of obs =   229862
                                                      F(  2, 35788) =     9.48
                                                      Prob > F      =   0.0001
Total (centered) SS     =  65286353.41                Centered R2   =  -0.0004
Total (uncentered) SS   =  65286353.41                Uncentered R2 =  -0.0004
Residual SS             =  65313979.12                Root MSE      =    16.94

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.609242   2.820541    -1.28   0.201    -9.137588    1.919105
        var4 |  -.6319906   .6427621    -0.98   0.325    -1.891824    .6278425
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            485.130
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             5804.156
                         (Kleibergen-Paap rk Wald F statistic):        543.257
Stock-Yogo weak ID test critical values: 10% maximal IV size             16.38
                                         15% maximal IV size              8.96
                                         20% maximal IV size              6.66
                                         25% maximal IV size              5.53
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3
Included instruments: var4
Excluded instruments: var6
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     35789       35789           0    *|
     firm_id |      2151           1        2150     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
(results _ivreg2_var3 are active now)
→ Processing outcome: restricted_contributions_q100
(dropped 1443 singleton observations)
(MWFE estimator converged in 82 iterations)

HDFE Linear regression                            Number of obs   =    229,862
Absorbing 3 HDFE groups                           F(   2,  35788) =      15.49
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.6596
                                                  Adj R-squared   =     0.5923
                                                  Within R-sq.    =     0.0003
Number of clusters (user_id) =     35,789         Root MSE        =    20.2214

                           (Std. err. adjusted for 35,789 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
restrict~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -.5055142   .4628887    -1.09   0.275     -1.41279    .4017616
        var4 |  -1.671316     .33414    -5.00   0.000     -2.32624   -1.016391
       _cons |   48.54484   .1412956   343.57   0.000      48.2679    48.82179
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     35789       35789           0    *|
     firm_id |      2151           1        2150     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
(dropped 1443 singleton observations)
(MWFE estimator converged in 82 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          2  First-stage regression: var3
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35789                Number of obs =   229862
                                                      F(  2, 35788) =    15.53
                                                      Prob > F      =   0.0000
Total (centered) SS     =   78494862.2                Centered R2   =  -0.0001
Total (uncentered) SS   =   78494862.2                Uncentered R2 =  -0.0001
Residual SS             =  78502700.68                Root MSE      =    18.57

------------------------------------------------------------------------------
             |               Robust
restrict~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.363678   2.911309    -1.16   0.248    -9.069932    2.342576
        var4 |  -1.110302   .6539466    -1.70   0.090    -2.392057    .1714535
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            485.130
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             5804.156
                         (Kleibergen-Paap rk Wald F statistic):        543.257
Stock-Yogo weak ID test critical values: 10% maximal IV size             16.38
                                         15% maximal IV size              8.96
                                         20% maximal IV size              6.66
                                         25% maximal IV size              5.53
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3
Included instruments: var4
Excluded instruments: var6
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     35789       35789           0    *|
     firm_id |      2151           1        2150     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. // 4) Close & export to CSV
. postclose handle

. use `out', clear

. export delimited using "`result_dir'/consolidated_results.csv", ///
>     replace delimiter(",") quote
file /Users/saul/Dropbox/Remote Work Startups/main/results/raw/user_productivit
> y_initial_precovid/consolidated_results.csv saved

. 
. * --- write first-stage CSV -----------------------------------------
. postclose handle_fs

. use `out_fs', clear

. export delimited using "`result_dir'/first_stage.csv", ///
>         replace delimiter(",") quote
file /Users/saul/Dropbox/Remote Work Startups/main/results/raw/user_productivit
> y_initial_precovid/first_stage.csv saved

. 
. di as result "→ second-stage CSV : `result_dir'/consolidated_results.csv"
→ second-stage CSV : /Users/saul/Dropbox/Remote Work Startups/main/results/raw/
> user_productivity_initial_precovid/consolidated_results.csv

. di as result "→ first-stage  CSV : `result_dir'/first_stage.csv"
→ first-stage  CSV : /Users/saul/Dropbox/Remote Work Startups/main/results/raw/
> user_productivity_initial_precovid/first_stage.csv

. capture log close

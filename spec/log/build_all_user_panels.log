--------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/saul/Dropbox/Remote Work Startups/main/spec/log/build_all_user_panels.log
  log type:  text
 opened on:  14 Oct 2025, 07:49:56

. 
. ****************************************************************************
. * 0.  Globals
. ****************************************************************************
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. ****************************************************************************
. * 1.  Build the *full* (unfiltered) master panel
. ****************************************************************************
. 
. // use "$raw_data/All_Contributions_month.dta", clear
. // keep if year == 2016
. // gen half = ceil(month/6)
. // gen yh   = yh(year, half)
. // format yh %th
. //
. // collapse (sum) totalcontribution (sum) restrictedcontributionscount, by(user_id yh)
. //
. // tempfile user_yh_2016
. // save     "`user_yh_2016'", replace
. //
. // use "$processed_data/expanded_half_years_2.dta", clear
. // keep if y == 2016
. // keep user_id companyname yh
. //
. // duplicates tag user_id yh, gen(dup_tag)
. // keep if dup_tag==0
. // drop dup_tag
. //
. // merge 1:1 user_id yh using "`user_yh_2016'", keep(3) nogen
. //
. // save   "`user_yh_2016'", replace
. 
. *----------------------------------------------------------
. * 1.1  User-level contributions (historic)
. *----------------------------------------------------------
. use "$processed_data/Contributions_Scoop.dta", clear

. 
. * drop inactive accounts --------------------------------------------------
. gsort user_id year month

. by user_id: egen any_contributions = max(totalcontribution)

. keep if any_contributions
(3,716,732 observations deleted)

. 
. * derive half-year id ------------------------------------------------------
. gen half = ceil(month/6)

. gen yh   = yh(year, half)

. format yh %th

. 
. * monthly â†’ half-year collapse -------------------------------------------*
. collapse (sum) totalcontribution (sum) restrictedcontributionscount ///
>          (first) companyname, by(user_id yh)

. label var totalcontribution            "Total Contributions"

. label var restrictedcontributionscount "Pvt Contributions"

. 
. keep if yh <= yh(2022,1)
(0 observations deleted)

. 
. tempfile user_yh

. save     "`user_yh'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000001 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000001 saved as .dta format

. 
. *----------------------------------------------------------
. * 1.2  Add 2022 H1 contributions (monthly CSV)
. *----------------------------------------------------------
. import delimited "$raw_data/MonthlyContributions.csv", clear
(encoding automatically selected: ISO-8859-1)
(5 vars, 6,368,184 obs)

. 
. tostring monthyear, replace format(%06.0f)
monthyear was long now str6

. gen year  = substr(monthyear,1,4)

. gen month = substr(monthyear,5,2)

. 
. destring year month, replace
year: all characters numeric; replaced as int
month: all characters numeric; replaced as byte

. 
. gen half = ceil(month/6)

. gen yh   = yh(year, half)

. format yh %th

. 
. collapse (sum) totalcontribution (sum) restrictedcontributionscount, by(user_id yh)

. keep if yh == yh(2022,1)
(884,470 observations deleted)

. label var totalcontribution            "Total Contributions"

. label var restrictedcontributionscount "Pvt Contributions"

. 
. tempfile user_yh_new

. save     "`user_yh_new'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000002 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000002 saved as .dta format

. 
. * attach company names -----------------------------------------------------
. use "$processed_data/expanded_half_years_2.dta", clear

. keep if yh == yh(2022,1)
(3,129,979 observations deleted)

. keep user_id companyname yh

. 
. duplicates tag user_id yh, gen(dup_tag)

Duplicates in terms of user_id yh

. keep if dup_tag==0
(13,406 observations deleted)

. drop dup_tag

. 
. merge 1:1 user_id yh using "`user_yh_new'", keep(3) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           122,584  
    -----------------------------------------

. 
. append using "`user_yh'"

. save   "`user_yh'", replace
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000001 saved as .dta format

. 
. 
. *----------------------------------------------------------
. * 1.3  Merge firm-level characteristics (logic identical to original)
. *----------------------------------------------------------
. use "`user_yh'", clear

. 
. * teleworkability ---------------------------------------------------------*
. merge m:1 companyname using "$processed_data/scoop_firm_tele_2.dta", keep(3) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         1,351,106  
    -----------------------------------------

. rename teleworkable company_teleworkable

. 
. * flexibility score -------------------------------------------------------*
. merge m:1 companyname using "$raw_data/Scoop_clean_public.dta", keep(3) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         1,241,977  
    -----------------------------------------

. 
. * founding year -----------------------------------------------------------*
. merge m:1 companyname using "$raw_data/Scoop_founding.dta",     keep(3) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         1,241,977  
    -----------------------------------------

. 
. * linkedin ground-truth ---------------------------------------------------*
. merge 1:1 user_id companyname yh using "$processed_data/expanded_half_years_2.dta", keep(3) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         1,231,654  
    -----------------------------------------

. 
. tempfile snapshot_clean

. save     "`snapshot_clean'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000003 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000003 saved as .dta format

. 
. *----------------------------------------------------------
. * 1.4  Hierarchy / HHI merge  (keep _merge==2|3)
. *----------------------------------------------------------
. use "$processed_data/Firm_role_level.dta", clear

. keep companyname hhi_1000 seniority_levels

. 
. merge 1:m companyname using "`snapshot_clean'"

    Result                      Number of obs
    -----------------------------------------
    Not matched                         1,668
        from master                     1,261  (_merge==1)
        from using                        407  (_merge==2)

    Matched                         1,231,247  (_merge==3)
    -----------------------------------------

. drop if _merge==1   // drop firms absent from worker panel
(1,261 observations deleted)

. drop _merge

. 
. save "`snapshot_clean'", replace
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000003 saved as .dta format

. 
. import delimited "$processed_data/company_dispersion_2019.csv", clear
(encoding automatically selected: ISO-8859-1)
(3 vars, 4,162 obs)

. tempfile disp_metrics

. save     "`disp_metrics'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000004 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000004 saved as .dta format

. 
. import delimited "$processed_data/company_top_msa_by_half.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 236,600 obs)

. gen yh = yh(year, half)

. format yh %th

. rename msa company_msa

. rename cbsacode company_cbsacode

. tempfile pop_msa

. save   "`pop_msa'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000005 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000005 saved as .dta format

. 
. 
. import delimited "$raw_data/linkedin_msa_with_cbsa.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 404 obs)

. 
. merge 1:m msa using "`snapshot_clean'"

    Result                      Number of obs
    -----------------------------------------
    Not matched                            12
        from master                        12  (_merge==1)
        from using                          0  (_merge==2)

    Matched                         1,231,654  (_merge==3)
    -----------------------------------------

. drop if _merge == 1
(12 observations deleted)

. drop _merge

. 
. merge m:1 companyname using "`disp_metrics'"

    Result                      Number of obs
    -----------------------------------------
    Not matched                         1,459
        from master                       220  (_merge==1)
        from using                      1,239  (_merge==2)

    Matched                         1,231,434  (_merge==3)
    -----------------------------------------

. drop if _merge == 2
(1,239 observations deleted)

. drop _merge

. 
. merge m:1 companyname yh using "`pop_msa'"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       208,239
        from master                        94  (_merge==1)
        from using                    208,145  (_merge==2)

    Matched                         1,231,560  (_merge==3)
    -----------------------------------------

. drop if _merge == 2
(208,145 observations deleted)

. drop _merge

. 
. save "`snapshot_clean'", replace
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000003 saved as .dta format

. 
. *----------------------------------------------------------
. * 1.5  Commercial real-estate rents  (keep _merge==1|3)
. *----------------------------------------------------------
. use "$raw_data/data_20240523_lease.dta", clear

. keep if !missing(execution_month, execution_year)
(0 observations deleted)

. drop id_Lease

. 
. gen half = ceil(execution_month/6)

. gen yh   = yh(execution_year, half)

. format yh %th

. 
. keep if yh < yh(2020,1)
(112,516 observations deleted)

. collapse (mean) effectiverent2212usdperyear [fw=transactionsqft], by(city state)

. 
. rename city  hqcity

. rename state hqstate

. 
. sort hqcity hqstate

. 
. tempfile _lease

. save     "`_lease'", replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000006 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_37672.000006 saved as .dta format

. 
. use "`snapshot_clean'", clear

. merge m:1 hqcity hqstate using "`_lease'"
(variable hqcity was str25, now str40 to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                        41,858
        from master                    37,507  (_merge==1)
        from using                      4,351  (_merge==2)

    Matched                         1,194,147  (_merge==3)
    -----------------------------------------

. drop if _merge==2   // drop lease-only rows
(4,351 observations deleted)

. rename effectiverent2212usdperyear rent

. drop _merge

. 
.  
. merge m:1 user_id using "$processed_data/user_location_lookup.dta"

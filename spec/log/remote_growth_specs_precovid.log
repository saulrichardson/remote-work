---------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/saul/Dropbox/Remote Work Startups/main/spec/log/remote_growth_specs_precovid.log
  log type:  text
 opened on:  30 Jul 2025, 10:38:59

. 
. *--------------------------------------------------------------------*
. * 1) Globals & result folder ---------------------------------------*
. *--------------------------------------------------------------------*
. do "../src/globals.do"                     // defines $processed_data, $results

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. local result_dir "$results/`specname'"

. cap mkdir "`result_dir'"

. 
. *--------------------------------------------------------------------*
. * 2) Load user panel once ------------------------------------------*
. *--------------------------------------------------------------------*
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. tempfile userpanel

. save `userpanel', replace                     // keep a pristine copy
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000001 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000001 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3) Create company-level Covid-period growth -----------------------*
. *--------------------------------------------------------------------*
. tempfile industries industry_growth industry_growth_yh ///
>     company_growth company_growth_yh ///
>     msa_growth_yh size_yh ///
>     firm_growth

. 
. * 3a. map companies → industry & MSA
. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     keep companyname industry company_msa

.     save `industries', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. * 3b. bring in Scoop head-count file once
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

. drop v1

. gen date_numeric = date(date, "YMD")

. drop date

. rename date_numeric date

. format date %td

. 
. gen yh = hofd(date)

. gen year = yofd(date)

. format yh %th

. 
. gen byte covid = yh >= 120                 // 2020-H1 and after

. 
. *── 3c. INDUSTRY‐growth by half‐year ───────────────────────────────*
. preserve

.     merge m:1 companyname using `industries', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       153,494
        from master                   153,494  
        from using                          0  

    Matched                           170,181  
    -----------------------------------------

.     collapse (last) total_employees covid industry, by(yh companyname)

.     encode companyname, gen(company_numeric)

.         xtset company_numeric yh

Panel variable: company_numeric (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.     gen fg = (total_employees/L.total_employees)-1 if _n>1
(4,417 missing values generated)

.     winsor2 fg, cuts(1 99) suffix(_we)

.     * now average over firms within each industry×yh *
.     collapse (mean) fg_we if covid, by(industry yh)

.     rename fg_we ind_growth_favg_yh

.     save `industry_growth_yh', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000004 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000004 saved as .dta format

. restore

. 
. *── 3d. COMPANY‐growth by half‐year ────────────────────────────────*
. preserve

.     merge m:1 companyname using `industries', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       153,494
        from master                   153,494  
        from using                          0  

    Matched                           170,181  
    -----------------------------------------

.     collapse (last) total_employees covid, by(yh companyname)

.     encode companyname, gen(company_numeric)

.         xtset company_numeric yh

Panel variable: company_numeric (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.     gen growth = (total_employees/L.total_employees)-1 if _n>1
(4,415 missing values generated)

.     winsor2 growth, cuts(1 99) suffix(_we)

.     * now average over that firm×yh *
.     collapse (mean) growth_we if covid, by(companyname yh)

.     rename growth_we growth_rate_we_post_c_yh

.     save `company_growth_yh', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000006 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000006 saved as .dta format

. restore

. 
. *── 3e. MSA‐growth by half‐year ────────────────────────────────────*
. preserve

.     merge m:1 companyname using `industries', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       153,494
        from master                   153,494  
        from using                          0  

    Matched                           170,181  
    -----------------------------------------

.     collapse (last) total_employees covid company_msa, by(yh companyname)

.     encode companyname, gen(company_numeric)

.         xtset company_numeric yh

Panel variable: company_numeric (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.     gen fg = (total_employees/L.total_employees)-1 if _n>1
(4,415 missing values generated)

.     winsor2 fg, cuts(1 99) suffix(_we)

.     * now average over that MSA×yh *
.     collapse (mean) fg_we if covid, by(company_msa yh)

.     rename fg_we msa_growth_favg_yh

.     save `msa_growth_yh', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

. restore

. 
. 
. *── 3f. Firm size by half-year ─────────────────────────────────────*
. preserve

.     // start from the same scoop dataset you used for growth
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

.     gen date_numeric = date(date, "YMD")

.     drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
.     // grab the last head-count in each half-year for each firm
.     collapse (last) total_employees, by(yh companyname)

.     rename total_employees emp_yh

. 
.     save `size_yh', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore

. 
. 
. *--------------------------------------------------------------------*
. * 3e. Combine for leave-out means & growth bins ---------------------*
. *--------------------------------------------------------------------*
. use `company_growth_yh', clear   // now one row per firm×yh

. merge m:1 companyname using `industries', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        10,512
        from master                    10,512  
        from using                          0  

    Matched                            11,119  
    -----------------------------------------

. merge m:1 industry   yh  using `industry_growth_yh', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa yh using `msa_growth_yh', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname yh using `size_yh', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        32,544
        from master                         0  
        from using                     32,544  

    Matched                            21,631  
    -----------------------------------------

. 
. *--------------------------------------------------------------------
. * Jackknife (leave-one-out) group means for instruments
. *--------------------------------------------------------------------
. 
. * Leave-one-out industry mean in each yh *
. bysort industry yh: egen ind_sum_yh = total(ind_growth_favg_yh)

. bysort industry yh: egen ind_n_yh   = count(ind_growth_favg_yh)

. gen   avg_ind_yh = (ind_sum_yh - ind_growth_favg_yh) / (ind_n_yh - 1) ///
>       if ind_n_yh>1
(32,544 missing values generated)

. 
. * Leave-one-out MSA mean in each yh *
. bysort company_msa yh: egen msa_sum_yh = total(msa_growth_favg_yh)

. bysort company_msa yh: egen msa_n_yh   = count(msa_growth_favg_yh)

. gen   avg_msa_yh = (msa_sum_yh - msa_growth_favg_yh)/(msa_n_yh-1) if msa_n_yh>1
(32,838 missing values generated)

. 
.           
. egen growth_bin_yh = xtile(growth_rate_we_post_c_yh), by(yh) nq(2)
(32,670 missing values generated)

. egen ind_bin_yh    = xtile(avg_ind_yh),                by(yh) nq(2)
(32,544 missing values generated)

. egen msa_bin_yh    = xtile(avg_msa_yh),                by(yh) nq(2)
(32,838 missing values generated)

. egen size_bin_yh   = xtile(emp_yh),                    by(yh) nq(2)

. 
. 
. 
. collapse (mean) avg_ind_yh avg_msa_yh, by(companyname)

. 
. // capture drop ind_sum_raw ind_n_raw ind_sum_favg ind_n_favg
. 
. *--- CREATE the series you'll use in the tile regression -------------
. // gen   avg_ind_yh = avg_ind_favg_lo_yh    
. 
. 
. 
. // keep companyname growth_rate_we_post_c avg_ind avg_ind_favg_lo avg_msa 
. 
. save `firm_growth', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000009 not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000009 saved as .dta format

. 
. 
. 
. *--------------------------------------------------------------------*
. * 4) Merge growth info back to user panel    build emp_pre ---------*
. *--------------------------------------------------------------------*
. use `userpanel', clear                           // reload pristine panel

. merge m:1 companyname  yh using `firm_growth', nogenerate
variable yh not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. // collapse (mean) fg_we, by(industry)
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. keep industry ind_growth_postavg_lo

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. // collapse (mean) fg_we, by(company_msa)
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. merge m:1 industry     using `ind_postavg',  keep(match) nogen
variable industry does not uniquely identify observations in the using data
r(459);

end of do-file

r(459);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. // collapse (mean) fg_we, by(industry)
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. keep industry ind_growth_postavg_lo

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. // collapse (mean) fg_we, by(company_msa)
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. 
. 
. // merge m:1 `comp_postavg'  using `msa_postavg',  keep(match) nogen
. 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. 
. 
. // merge m:1 `comp_postavg'  using `msa_postavg',  keep(match) nogen
. 
. 
. 
. keep companyname yh ind_growth_postavg msa_growth_postavg

. tempfile jack_bartik

. save `jack_bartik', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. *------------------------------------------------------------------*
. * 6.  Merge into the main user panel                               *
. *------------------------------------------------------------------*
. use `main_panel', clear                     // your panel from earlier

. merge m:1 companyname yh using `jack_bartik', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           103,087  
    -----------------------------------------

. 
. 
. 
end of do-file

. reghdfe post_covid_growth_we rent_pctile hhi_hq_fw_lg ind_growth_favg_yh msa_growth_favg_yh
variable post_covid_growth_we not found
r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. 
. 
. // merge m:1 `comp_postavg'  using `msa_postavg',  keep(match) nogen
. 
. 
. 
. keep companyname yh ind_growth_postavg msa_growth_postavg

. tempfile jack_bartik

. save `jack_bartik', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. *------------------------------------------------------------------*
. * 6.  Merge into the main user panel                               *
. *------------------------------------------------------------------*
. use `main_panel', clear                     // your panel from earlier

. merge m:1 companyname yh using `jack_bartik', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           103,087  
    -----------------------------------------

. 
. 
. 
. 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. 
end of do-file

. reghdfe growth_rate_we_post_c rent_pctile hhi_hq_fw_lg ind_growth_favg_yh msa_growth_favg_yh
variable rent_pctile not found
r(111);

. reghdfe growth_rate_we_post_c ind_growth_favg_yh msa_growth_favg_yh
variable ind_growth_favg_yh not found
r(111);

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     21,627
Absorbing 1 HDFE group                            F(   2,  21624) =     536.34
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0473
                                                  Adj R-squared   =     0.0472
                                                  Within R-sq.    =     0.0473
                                                  Root MSE        =     0.1770

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .7218068   .0410045    17.60   0.000      .641435    .8021786
msa_growth_postavg_lo |   .6988556   .0419618    16.65   0.000     .6166074    .7811039
                _cons |  -.0374435    .004274    -8.76   0.000    -.0458207   -.0290662
---------------------------------------------------------------------------------------

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         collapse (last) rent hhi_1000 if covid, by(companyname_c)
covid not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

.     keep companyname rent hhi_1000

.     gen companyname_c = lower(companyname)

.         gen byte covid = (yh >= 120)
yh not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid

.     gen companyname_c = lower(companyname)

.         
.         collapse (last) rent hhi_1000 if covid, by(companyname_c)

.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen
variable companyname_c not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) rent hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen
variable companyname_c not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) rent hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
end of do-file

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     17,513
Absorbing 1 HDFE group                            F(   2,  17510) =     419.78
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0458
                                                  Adj R-squared   =     0.0456
                                                  Within R-sq.    =     0.0458
                                                  Root MSE        =     0.1240

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .4966211   .0288459    17.22   0.000     .4400802     .553162
msa_growth_postavg_lo |   .4192546   .0299226    14.01   0.000     .3606033    .4779059
                _cons |  -.0160298    .003038    -5.28   0.000    -.0219846   -.0100751
---------------------------------------------------------------------------------------

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     458.02
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1018
                                                  Adj R-squared   =     0.1016
                                                  Within R-sq.    =     0.1018
                                                  Root MSE        =     0.1206

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5267446   .0294142    17.91   0.000     .4690894    .5843997
msa_growth_postavg_lo |   .1177655   .0315678     3.73   0.000     .0558892    .1796419
            tile_rent |   .0555334   .0019892    27.92   0.000     .0516343    .0594325
             tile_hhi |    .031913   .0019491    16.37   0.000     .0280925    .0357335
                _cons |  -.1216751   .0046356   -26.25   0.000    -.1307614   -.1125888
---------------------------------------------------------------------------------------

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. xtile tile_growth_resid = growth_resid, yq(2)
option yq() not allowed
r(198);

end of do-file

r(198);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup
startup not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) rent hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. // merge m:1 `comp_postavg'  using `msa_postavg',  keep(match) nogen
. 
. 
. 
. keep companyname yh ind_growth_postavg msa_growth_postavg

. tempfile jack_bartik

. save `jack_bartik', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d not found)
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. *------------------------------------------------------------------*
. * 6.  Merge into the main user panel                               *
. *------------------------------------------------------------------*
. use `main_panel', clear                     // your panel from earlier

. merge m:1 companyname yh using `jack_bartik', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           103,087  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
variable growth_rate_we_post_c not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) rent hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     459.19
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1021
                                                  Adj R-squared   =     0.1018
                                                  Within R-sq.    =     0.1021
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5195371   .0295206    17.60   0.000     .4616733    .5774008
msa_growth_postavg_lo |   .1335726   .0314051     4.25   0.000     .0720151      .19513
            tile_rent |   .0553207   .0019829    27.90   0.000      .051434    .0592074
             tile_hhi |    .031767   .0019492    16.30   0.000     .0279463    .0355877
                _cons |  -.1219184   .0046335   -26.31   0.000    -.1310006   -.1128361
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup
startup not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     461.35
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1025
                                                  Adj R-squared   =     0.1023
                                                  Within R-sq.    =     0.1025
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5106583   .0294382    17.35   0.000     .4529561    .5683605
msa_growth_postavg_lo |   .1570296   .0308661     5.09   0.000     .0965286    .2175306
            tile_rent |   .0549393   .0019778    27.78   0.000     .0510625     .058816
             tile_hhi |   .0315704   .0019482    16.20   0.000     .0277517    .0353891
                _cons |  -.1223788   .0046324   -26.42   0.000    -.1314589   -.1132988
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. merge 1:m companyname using `main_panel', clear       
option clear not allowed
r(198);

end of do-file

r(198);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  5, 35252) =    10.27
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =   0.0005
Total (uncentered) SS   =  56201148.19                Uncentered R2 =   0.0005
Residual SS             =   56174397.2                Root MSE      =    15.88

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -3.854046   3.875351    -0.99   0.320    -11.44985    3.741762
        var5 |   6.780958   5.716312     1.19   0.236    -4.423192    17.98511
        var4 |  -9.046603   4.031525    -2.24   0.025    -16.94852   -1.144688
       var17 |  -1.483366   .3066939    -4.84   0.000    -2.084496   -.8822363
       var18 |   1.475837   .8388201     1.76   0.079    -.1682767    3.119951
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            253.396
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1933.040
                         (Kleibergen-Paap rk Wald F statistic):        135.346
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. reghdfe total_contributions_q100 growth_rate_we_post_c
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =    229,238
Absorbing 1 HDFE group                            F(   1, 229236) =    4247.44
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0182
                                                  Adj R-squared   =     0.0182
                                                  Within R-sq.    =     0.0182
                                                  Root MSE        =    29.6313

---------------------------------------------------------------------------------------
total_contributio~100 | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
growth_rate_we_post_c |   46.21849   .7091727    65.17   0.000     44.82853    47.60845
                _cons |   46.84475   .0743988   629.64   0.000     46.69893    46.99057
---------------------------------------------------------------------------------------

. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     457.02
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1016
                                                  Adj R-squared   =     0.1014
                                                  Within R-sq.    =     0.1016
                                                  Root MSE        =     0.1206

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5319287   .0295198    18.02   0.000     .4740667    .5897908
msa_growth_postavg_lo |   .1025931   .0319693     3.21   0.001     .0399298    .1652563
            tile_rent |   .0558381   .0019892    28.07   0.000      .051939    .0597373
             tile_hhi |   .0320676   .0019485    16.46   0.000     .0282483     .035887
                _cons |  -.1214602   .0046392   -26.18   0.000    -.1305536   -.1123668
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. merge 1:m companyname using `main_panel'
variable companyname does not uniquely identify observations in the master data
r(459);

end of do-file

r(459);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. reghdfe total_contributions_q100 var3 var5 var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   3,  35252) =      16.37
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7180
                                                  Adj R-squared   =     0.6519
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,253         Root MSE        =    17.6455

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.191012   .4961626    -2.40   0.016    -2.163506   -.2185181
        var5 |   6.207724   1.282272     4.84   0.000     3.694431    8.721016
        var4 |  -6.712415   1.103252    -6.08   0.000    -8.874823   -4.550007
       _cons |   50.36931   .1499799   335.84   0.000     50.07534    50.66327
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. //      savefirst
.         
. reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) 
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    222,715
Absorbing 2 HDFE groups                           F(   5,  35252) =      14.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7181
                                                  Adj R-squared   =     0.6520
                                                  Within R-sq.    =     0.0009
Number of clusters (user_id) =     35,253         Root MSE        =    17.6430

                           (Std. err. adjusted for 35,253 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.170123   .4955962    -2.36   0.018    -2.141507   -.1987391
        var5 |   6.249409   1.301721     4.80   0.000     3.697995    8.800823
        var4 |  -8.743296   1.568677    -5.57   0.000    -11.81795   -5.668639
       var17 |  -1.497296   .3060393    -4.89   0.000    -2.097143   -.8974496
       var18 |   1.267134    .755391     1.68   0.093    -.2134557    2.747724
       _cons |   51.45963   .2693046   191.08   0.000     50.93178    51.98748
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. //      savefirst
.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.         
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6523 singleton observations)
--Break--
r(1);

end of do-file

--Break--
r(1);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
.     absorb(firm_id#user_id yh) vce(cluster user_id) 
command absorb is unrecognized
r(199);

end of do-file

r(199);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     463.17
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1029
                                                  Adj R-squared   =     0.1026
                                                  Within R-sq.    =     0.1029
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |    .503895   .0294136    17.13   0.000      .446241    .5615489
msa_growth_postavg_lo |   .1730145   .0303873     5.69   0.000     .1134521    .2325769
            tile_rent |   .0543317   .0019914    27.28   0.000     .0504283    .0582352
             tile_hhi |   .0313927   .0019483    16.11   0.000     .0275738    .0352117
                _cons |   -.122039   .0046189   -26.42   0.000    -.1310925   -.1129855
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. collapse (last) var17 (last) var18 (last) growth_resid,by(companyname)

. 
. 
. merge 1:m companyname using `main_panel'
variable _merge already defined
r(110);

end of do-file

r(110);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     459.10
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1021
                                                  Adj R-squared   =     0.1018
                                                  Within R-sq.    =     0.1021
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5208534   .0294368    17.69   0.000      .463154    .5785528
msa_growth_postavg_lo |   .1315562   .0311941     4.22   0.000     .0704123    .1927001
            tile_rent |   .0552675   .0019879    27.80   0.000      .051371    .0591639
             tile_hhi |   .0318271   .0019477    16.34   0.000     .0280095    .0356448
                _cons |  -.1218577   .0046324   -26.31   0.000    -.1309378   -.1127776
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. collapse (last) var17 (last) var18 (last) growth_resid,by(companyname)

. 
. capture drop _merge

. 
. merge 1:m companyname using `main_panel'
variable _merge already defined
r(110);

end of do-file

r(110);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. drop _merge
variable _merge not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     459.16
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1021
                                                  Adj R-squared   =     0.1018
                                                  Within R-sq.    =     0.1021
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5194075   .0295464    17.58   0.000     .4614932    .5773217
msa_growth_postavg_lo |    .132988   .0313562     4.24   0.000     .0715265    .1944496
            tile_rent |   .0551645   .0019941    27.66   0.000      .051256    .0590731
             tile_hhi |   .0317704   .0019492    16.30   0.000     .0279497    .0355911
                _cons |   -.121625    .004626   -26.29   0.000    -.1306925   -.1125576
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. collapse (last) var17 (last) var18 (last) growth_resid,by(companyname)

. 
. drop _merge
variable _merge not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     457.75
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1018
                                                  Adj R-squared   =     0.1016
                                                  Within R-sq.    =     0.1018
                                                  Root MSE        =     0.1206

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5278299   .0294672    17.91   0.000     .4700711    .5855888
msa_growth_postavg_lo |   .1131548   .0314732     3.60   0.000      .051464    .1748457
            tile_rent |   .0554784   .0020004    27.73   0.000     .0515573    .0593995
             tile_hhi |   .0318698   .0019522    16.33   0.000     .0280434    .0356963
                _cons |  -.1211941   .0046234   -26.21   0.000    -.1302565   -.1121318
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. collapse (last) var17 (last) var18 (last) growth_resid,by(companyname)

. 
. // drop _merge
. 
. merge 1:m companyname using `main_panel'

    Result                      Number of obs
    -----------------------------------------
    Not matched                         1,414
        from master                     1,414  (_merge==1)
        from using                          0  (_merge==2)

    Matched                           229,238  (_merge==3)
    -----------------------------------------

. 
. 
. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id firm_id yh) vce(cluster user_id) savefirst       
(dropped 1472 singleton observations)
(MWFE estimator converged in 87 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35564                Number of obs =   227766
                                                      F(  5, 35563) =     4.10
                                                      Prob > F      =   0.0010
Total (centered) SS     =  64646101.91                Centered R2   =  -0.0015
Total (uncentered) SS   =  64646101.91                Uncentered R2 =  -0.0015
Residual SS             =  64739885.56                Root MSE      =    16.94

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -7.172485    3.90787    -1.84   0.066    -14.83203    .4870604
        var5 |   9.864266   5.446322     1.81   0.070    -.8106932    20.53922
        var4 |  -8.282087   4.104882    -2.02   0.044    -16.32778   -.2363918
       var17 |  -23.55478    1314782    -0.00   1.000     -2577037     2576990
       var18 |  -26.06981    1193891    -0.00   1.000     -2340090     2340037
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            265.245
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1830.897
                         (Kleibergen-Paap rk Wald F statistic):        140.039
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     35564       35564           0    *|
     firm_id |      2018           1        2017     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
. 
.                 
. 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id#firm_id yh) vce(cluster user_id) savefirst       
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)
estimates post: matrix has missing values
r(504);

end of do-file

r(504);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id#firm_id yh) vce(cluster user_id) savefirst       
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)
estimates post: matrix has missing values
r(504);

end of do-file

r(504);

. sum  var17

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       var17 |    230,652    1.619561    .4854958          1          2

. sum var18

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       var18 |    230,652    .3348161    .7190179          0          2

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
>         absorb(user_id#firm_id yh) vce(cluster user_id) savefirst     
(dropped 6523 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35253                Number of obs =   222715
                                                      F(  3, 35252) =    10.46
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56201148.19                Centered R2   =  -0.0028
Total (uncentered) SS   =  56201148.19                Uncentered R2 =  -0.0028
Residual SS             =  56359908.39                Root MSE      =    15.91

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.425195   4.019928    -2.34   0.019    -17.30438   -1.546011
        var5 |   12.33928   5.460381     2.26   0.024     1.636766     23.0418
        var4 |  -10.30489   4.095222    -2.52   0.012    -18.33165   -2.278123
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.801
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1837.178
                         (Kleibergen-Paap rk Wald F statistic):        123.265
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   user_id#firm_id |     42306       42306           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     461.01
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1024
                                                  Adj R-squared   =     0.1022
                                                  Within R-sq.    =     0.1024
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5120872   .0294403    17.39   0.000     .4543809    .5697935
msa_growth_postavg_lo |   .1532071   .0308681     4.96   0.000     .0927021    .2137121
            tile_rent |    .054885   .0019847    27.65   0.000     .0509947    .0587753
             tile_hhi |   .0316317   .0019475    16.24   0.000     .0278144    .0354491
                _cons |  -.1221683   .0046293   -26.39   0.000    -.1312422   -.1130944
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. // drop _merge
. 
. merge 1:m companyname yh using `main_panel'
(variable covid was byte, now float to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       135,372
        from master                     9,221  (_merge==1)
        from using                    126,151  (_merge==2)

    Matched                           103,087  (_merge==3)
    -----------------------------------------

. 
. 
. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id#firm_id yh) vce(cluster user_id) savefirst  
(dropped 7253 singleton observations)
(MWFE estimator converged in 6 iterations)
estimates post: matrix has missing values
r(504);

end of do-file

r(504);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     458.60
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1020
                                                  Adj R-squared   =     0.1017
                                                  Within R-sq.    =     0.1020
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5240287   .0293782    17.84   0.000     .4664441    .5816133
msa_growth_postavg_lo |   .1257119   .0314562     4.00   0.000     .0640542    .1873696
            tile_rent |   .0552667   .0019975    27.67   0.000     .0513514     .059182
             tile_hhi |   .0318442    .001949    16.34   0.000      .028024    .0356645
                _cons |  -.1216543   .0046303   -26.27   0.000    -.1307302   -.1125784
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. // drop _merge
. 
. merge 1:m companyname yh using `main_panel'
(variable covid was byte, now float to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       135,372
        from master                     9,221  (_merge==1)
        from using                    126,151  (_merge==2)

    Matched                           103,087  (_merge==3)
    -----------------------------------------

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     459.85
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1022
                                                  Adj R-squared   =     0.1020
                                                  Within R-sq.    =     0.1022
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5175035   .0294154    17.59   0.000      .459846     .575161
msa_growth_postavg_lo |   .1403809   .0310222     4.53   0.000     .0795739    .2011878
            tile_rent |   .0551491    .001984    27.80   0.000     .0512603    .0590379
             tile_hhi |    .031699    .001949    16.26   0.000     .0278787    .0355192
                _cons |  -.1219907   .0046312   -26.34   0.000    -.1310684   -.1129131
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. // drop _merge
. 
. merge 1:m companyname yh using `main_panel'
(variable covid was byte, now float to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       135,372
        from master                     9,221  (_merge==1)
        from using                    126,151  (_merge==2)

    Matched                           103,087  (_merge==3)
    -----------------------------------------

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     461.45
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1025
                                                  Adj R-squared   =     0.1023
                                                  Within R-sq.    =     0.1025
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5102855   .0294344    17.34   0.000     .4525908    .5679803
msa_growth_postavg_lo |   .1580921   .0308567     5.12   0.000     .0976096    .2185747
            tile_rent |   .0548459   .0019818    27.67   0.000     .0509614    .0587304
             tile_hhi |   .0315369   .0019488    16.18   0.000      .027717    .0353568
                _cons |  -.1222612   .0046293   -26.41   0.000    -.1313351   -.1131874
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. // drop _merge
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. merge companyname yh m:1 using `firm_measures'
(you are using old merge syntax; see [D] merge for new syntax)
: invalid name
r(198);

end of do-file

r(198);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     457.38
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1017
                                                  Adj R-squared   =     0.1015
                                                  Within R-sq.    =     0.1017
                                                  Root MSE        =     0.1206

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5296802   .0295103    17.95   0.000     .4718367    .5875237
msa_growth_postavg_lo |     .10833   .0318073     3.41   0.001     .0459842    .1706757
            tile_rent |   .0557684   .0019854    28.09   0.000     .0518767      .05966
             tile_hhi |   .0319576   .0019508    16.38   0.000     .0281338    .0357814
                _cons |  -.1214987   .0046362   -26.21   0.000    -.1305862   -.1124113
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. // drop _merge
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. merge m:1 companyname yh  using `firm_measures'
variable _merge already defined
r(110);

end of do-file

r(110);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. drop _merge

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     458.91
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1020
                                                  Adj R-squared   =     0.1018
                                                  Within R-sq.    =     0.1020
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5222899   .0293901    17.77   0.000      .464682    .5798978
msa_growth_postavg_lo |   .1295029   .0313078     4.14   0.000     .0681361    .1908697
            tile_rent |   .0552281    .001994    27.70   0.000     .0513196    .0591367
             tile_hhi |   .0317614   .0019505    16.28   0.000     .0279383    .0355846
                _cons |  -.1216493    .004628   -26.29   0.000    -.1307208   -.1125778
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. 
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. capture drop _merge

. merge m:1 companyname yh  using `firm_measures'

    Result                      Number of obs
    -----------------------------------------
    Not matched                       137,439
        from master                   128,218  (_merge==1)
        from using                      9,221  (_merge==2)

    Matched                           103,087  (_merge==3)
    -----------------------------------------

. 
. 
. 
. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id#firm_id yh) vce(cluster user_id) savefirst  
(dropped 7253 singleton observations)
(MWFE estimator converged in 6 iterations)
estimates post: matrix has missing values
r(504);

end of do-file

r(504);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id firm_id yh) vce(cluster user_id) savefirst  
(dropped 5066 singleton observations)
(MWFE estimator converged in 105 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   23606                Number of obs =    98021
                                                      F(  5, 23605) =     0.00
                                                      Prob > F      =   1.0000
Total (centered) SS     =  18053057.24                Centered R2   =  -0.0000
Total (uncentered) SS   =  18053057.24                Uncentered R2 =  -0.0000
Residual SS             =  18053057.24                Root MSE      =    13.69

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1829.401   1.39e+07    -0.00   1.000    -2.72e+07    2.72e+07
        var5 |  -1462.402   2.44e+07    -0.00   1.000    -4.78e+07    4.78e+07
        var4 |  -3687.016   3.10e+07    -0.00   1.000    -6.08e+07    6.08e+07
       var17 |   -29.0255    5900219    -0.00   1.000    -1.16e+07    1.16e+07
       var18 |    2443.51   1.32e+07     0.00   1.000    -2.58e+07    2.58e+07
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):             26.868
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):              1.1e+04
                         (Kleibergen-Paap rk Wald F statistic):         14.012
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     23606       23606           0    *|
     firm_id |      1744           1        1743     |
          yh |         5           1           4     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     458.03
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1018
                                                  Adj R-squared   =     0.1016
                                                  Within R-sq.    =     0.1018
                                                  Root MSE        =     0.1206

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5271817   .0293676    17.95   0.000     .4696179    .5847455
msa_growth_postavg_lo |   .1178566   .0315863     3.73   0.000     .0559441    .1797692
            tile_rent |   .0555098   .0019911    27.88   0.000     .0516072    .0594125
             tile_hhi |   .0318469   .0019515    16.32   0.000     .0280217    .0356721
                _cons |  -.1215797   .0046326   -26.24   0.000      -.13066   -.1124993
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. 
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. capture drop _merge

. merge m:1 companyname  using `firm_measures'
variable companyname does not uniquely identify observations in the using data
r(459);

end of do-file

r(459);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     467.03
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1036
                                                  Adj R-squared   =     0.1034
                                                  Within R-sq.    =     0.1036
                                                  Root MSE        =     0.1204

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .4929338   .0292944    16.83   0.000     .4355134    .5503541
msa_growth_postavg_lo |   .2040186    .029983     6.80   0.000     .1452487    .2627885
            tile_rent |   .0538891   .0019815    27.20   0.000      .050005    .0577731
             tile_hhi |   .0310966   .0019477    15.97   0.000      .027279    .0349143
                _cons |  -.1227608   .0046203   -26.57   0.000    -.1318172   -.1137044
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. 
. // collapse (last) var17 (last) var18 (last) growth_resid, by(companyname)
. 
. 
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. capture drop _merge

. merge m:1 companyname  yh using `firm_measures'

    Result                      Number of obs
    -----------------------------------------
    Not matched                       137,439
        from master                   128,218  (_merge==1)
        from using                      9,221  (_merge==2)

    Matched                           103,087  (_merge==3)
    -----------------------------------------

. 
. 
. gen var17 = covid*tile_post_c
(128,218 missing values generated)

. gen var18 = covid*tile_post_c*startup
(128,218 missing values generated)

. 
. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id firm_id yh) vce(cluster user_id) savefirst 
(dropped 5066 singleton observations)
(MWFE estimator converged in 105 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   23606                Number of obs =    98021
                                                      F(  5, 23605) =     0.00
                                                      Prob > F      =   1.0000
Total (centered) SS     =  18053057.24                Centered R2   =   0.0000
Total (uncentered) SS   =  18053057.24                Uncentered R2 =   0.0000
Residual SS             =  18053057.24                Root MSE      =    13.69

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -2446.794   1.41e+07    -0.00   1.000    -2.77e+07    2.77e+07
        var5 |   874.6668   2.45e+07     0.00   1.000    -4.81e+07    4.81e+07
        var4 |  -17075.67   3.10e+07    -0.00   1.000    -6.09e+07    6.08e+07
       var17 |  -241.9049    6131115    -0.00   1.000    -1.20e+07    1.20e+07
       var18 |   8492.615   1.32e+07     0.00   0.999    -2.58e+07    2.58e+07
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):             26.573
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):              1.1e+04
                         (Kleibergen-Paap rk Wald F statistic):         13.782
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     23606       23606           0    *|
     firm_id |      1744           1        1743     |
          yh |         5           1           4     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.                 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     461.16
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1025
                                                  Adj R-squared   =     0.1022
                                                  Within R-sq.    =     0.1025
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5108898    .029485    17.33   0.000      .453096    .5686835
msa_growth_postavg_lo |    .154973   .0308881     5.02   0.000     .0944289     .215517
            tile_rent |   .0549094   .0019816    27.71   0.000     .0510252    .0587936
             tile_hhi |   .0316098   .0019477    16.23   0.000     .0277921    .0354275
                _cons |  -.1222385   .0046302   -26.40   0.000    -.1313142   -.1131629
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. 
. collapse  (last) tile_growth_resid, by(companyname)

. 
. 
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. capture drop _merge

. merge m:1 companyname using `firm_measures'

    Result                      Number of obs
    -----------------------------------------
    Not matched                         3,481
        from master                     2,067  (_merge==1)
        from using                      1,414  (_merge==2)

    Matched                           229,238  (_merge==3)
    -----------------------------------------

. 
. 
. gen var17 = covid*tile_post_c
tile_post_c not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000002 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000005 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000007 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000a saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. 
. 
. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     461.64
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1026
                                                  Adj R-squared   =     0.1023
                                                  Within R-sq.    =     0.1026
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5100006    .029399    17.35   0.000     .4523753    .5676259
msa_growth_postavg_lo |   .1594081   .0307287     5.19   0.000     .0991765    .2196397
            tile_rent |   .0547585   .0019846    27.59   0.000     .0508685    .0586485
             tile_hhi |   .0315966   .0019469    16.23   0.000     .0277805    .0354127
                _cons |  -.1223098   .0046295   -26.42   0.000    -.1313841   -.1132355
---------------------------------------------------------------------------------------

. predict growth_resid
(option xb assumed; fitted values)
(1,350 missing values generated)

. 
. xtile tile_growth_resid = growth_resid, nq(2)

. 
. collapse  (last) tile_growth_resid, by(companyname)

. 
. 
. 
. tempfile firm_measures

. save `firm_measures'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. capture drop _merge

. merge m:1 companyname using `firm_measures'

    Result                      Number of obs
    -----------------------------------------
    Not matched                         3,481
        from master                     2,067  (_merge==1)
        from using                      1,414  (_merge==2)

    Matched                           229,238  (_merge==3)
    -----------------------------------------

. 
. 
. gen var17 = covid*tile_growth_resid
(10,220 missing values generated)

. gen var18 = covid*tile_growth_resid*startup
(10,220 missing values generated)

. 
. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
>         absorb(user_id firm_id yh) vce(cluster user_id) savefirst 
(dropped 1517 singleton observations)
(MWFE estimator converged in 82 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   34650                Number of obs =   220982
                                                      F(  5, 34649) =     7.69
                                                      Prob > F      =   0.0000
Total (centered) SS     =  62457677.96                Centered R2   =  -0.0016
Total (uncentered) SS   =  62457677.96                Uncentered R2 =  -0.0016
Residual SS             =  62556677.86                Root MSE      =     16.9

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -7.362294   4.202887    -1.75   0.080    -15.60009    .8755004
        var5 |   8.735016   5.887332     1.48   0.138    -2.804346    20.27438
        var4 |  -10.14254   3.991766    -2.54   0.011    -17.96653   -2.318547
       var17 |   -.412283   .5481732    -0.75   0.452     -1.48672    .6621542
       var18 |   1.765744   .8772035     2.01   0.044     .0463963    3.485091
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            230.974
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1652.942
                         (Kleibergen-Paap rk Wald F statistic):        118.877
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var17 var18
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
     user_id |     34650       34650           0    *|
     firm_id |      1891           1        1890     |
          yh |        11           1          10     |
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

.                 
. 
.                 
. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. import delimited "/Users/saul/Dropbox/Remote Work Startups/main/data/processed/vacancy_measures_2020.csv"
no; data in memory would be lost
r(4);

end of do-file

r(4);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. import delimited "/Users/saul/Dropbox/Remote Work Startups/main/data/processed/vacancy_measures_2020.csv", clear
(encoding automatically selected: ISO-8859-1)
(7 vars, 3,298 obs)

. tempfile vacancies

. save `vacancies'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000001 saved as .dta format

. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000004 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000006 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000009 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. merge m:1 companyname using `vacancies'

    Result                      Number of obs
    -----------------------------------------
    Not matched                        20,697
        from master                    17,418  (_merge==1)
        from using                      3,279  (_merge==2)

    Matched                                95  (_merge==3)
    -----------------------------------------

. 
. 
. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     16,163
Absorbing 1 HDFE group                            F(   4,  16158) =     460.79
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1024
                                                  Adj R-squared   =     0.1022
                                                  Within R-sq.    =     0.1024
                                                  Root MSE        =     0.1205

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5156747   .0292289    17.64   0.000     .4583829    .5729665
msa_growth_postavg_lo |   .1501059   .0307283     4.88   0.000     .0898751    .2103368
            tile_rent |   .0549315   .0019847    27.68   0.000     .0510414    .0588217
             tile_hhi |   .0315964    .001949    16.21   0.000      .027776    .0354167
                _cons |  -.1222292   .0046318   -26.39   0.000    -.1313081   -.1131504
---------------------------------------------------------------------------------------

. 
end of do-file

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi vacancy_per_size
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =         90
Absorbing 1 HDFE group                            F(   5,     84) =       8.42
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.3338
                                                  Adj R-squared   =     0.2941
                                                  Within R-sq.    =     0.3338
                                                  Root MSE        =     0.1136

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .5833866   .4959389     1.18   0.243    -.4028423    1.569616
msa_growth_postavg_lo |   1.542507   .4821324     3.20   0.002      .583734     2.50128
            tile_rent |  -.1023887   .0474431    -2.16   0.034    -.1967344    -.008043
             tile_hhi |   .1011754   .0330529     3.06   0.003     .0354461    .1669047
     vacancy_per_size |   -.004344   .0010881    -3.99   0.000    -.0065079   -.0021802
                _cons |  -.0488882   .0796151    -0.61   0.541    -.2072115    .1094352
---------------------------------------------------------------------------------------

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi vacancy
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =         90
Absorbing 1 HDFE group                            F(   5,     84) =       4.40
                                                  Prob > F        =     0.0013
                                                  R-squared       =     0.2074
                                                  Adj R-squared   =     0.1602
                                                  Within R-sq.    =     0.2074
                                                  Root MSE        =     0.1239

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .6116506   .5685785     1.08   0.285    -.5190301    1.742331
msa_growth_postavg_lo |   1.217268   .5649834     2.15   0.034     .0937361    2.340799
            tile_rent |   -.082353   .0523113    -1.57   0.119    -.1863797    .0216738
             tile_hhi |   .0651669   .0346866     1.88   0.064    -.0038112     .134145
              vacancy |  -3.97e-07   .0000158    -0.03   0.980    -.0000319    .0000311
                _cons |   -.019648   .0906555    -0.22   0.829    -.1999265    .1606305
---------------------------------------------------------------------------------------

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. import delimited "/Users/saul/Dropbox/Remote Work Startups/main/data/processed/vacancy_measures_2020.csv", clear
(encoding automatically selected: ISO-8859-1)
(7 vars, 3,298 obs)

. 
end of do-file

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. import delimited "/Users/saul/Dropbox/Remote Work Startups/main/data/processed/vacancy_measures_2020.csv", clear
(encoding automatically selected: ISO-8859-1)
(7 vars, 3,298 obs)

. tempfile vacancies

. save `vacancies'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000001 saved as .dta format

. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000004 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000006 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000009 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. merge m:1 companyname_c using `vacancies'
variable companyname_c not found
r(111);

end of do-file

r(111);

. do "/var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//SD92404.000000"

. *====================================================================*
. *  spec/user_productivity_expost_growth_loop.do
. *  ------------------------------------------------------------------
. *  Single–pass IV that interacts the remote–work treatment (var5 / var3)
. *  with THREE alternative definitions of firms' ex-post scaling:
. *      1)  post_covid_growth_we          – pre-vs-post difference
. *      2)  growth_rate_we_post_c         – average Δlog employment during
. *                                           the post-Covid period
. *      3)  growth_yh_we                  – dynamic, half-year specific rate
. *  All growth variables are constructed on-the-fly from the raw Scoop
. *  head-count history.  Industry & MSA leave-one-out growth means are also
. *  built via a jack-knife for completeness (not used in the regression but
. *  available for future extensions).
. *
. *  Controls:
. *      • var4  (baseline)
. *      • rent_pctile   × yh   – from firm_panel
. *      • hhi_hq_fw_lg × yh    – from firm_panel (Lightcast concentration)
. *
. *  Fixed effects:  user_id  firm_id  industry#yh  msa#yh
. *  Cluster:        user_id
. *
. *  Results (one row per growth definition) are written to
. *      $results/remote_x_growth_loop_<panel_variant>.csv
. *====================================================================*
. 
. *--------------------------------------------------------------------*
. * 0. Parse optional panel variant argument  --------------------------*
. *--------------------------------------------------------------------*
. import delimited "/Users/saul/Dropbox/Remote Work Startups/main/data/processed/vacancy_measures_2020.csv", clear
(encoding automatically selected: ISO-8859-1)
(7 vars, 3,298 obs)

. rename  companyname companyname_c

. tempfile vacancies

. save `vacancies'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000001 saved as .dta format

. 
. args panel_variant

. if "`panel_variant'" == "" local panel_variant "precovid"

. 
. *--------------------------------------------------------------------*
. * 1. Globals & open main panel --------------------------------------*
. *--------------------------------------------------------------------*
. 
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen companyname_c = lower(companyname)

. 
. *--------------------------------------------------------------------*
. * 2. Bring in rent & HHI controls from the firm panel  --------------*
. *--------------------------------------------------------------------*
. 
. preserve

.     use "$processed_data/firm_panel.dta", clear

. //      gen byte covid = (yh >= 120)
.     keep companyname rent hhi_1000 covid startup

.         
.     gen companyname_c = lower(companyname)

.         
.         collapse (last) startup (last) rent (last) hhi_1000 if covid, by(companyname_c)

.         xtile tile_rent = rent, nq(2)

.         xtile tile_hhi = hhi_1000, nq(2)

.         
.     tempfile firm_extra

.     save `firm_extra'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000003 saved as .dta format

. restore

. 
. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. drop _merge

. 
. tempfile main_panel

. save `main_panel'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000004 saved as .dta format

. 
. *--------------------------------------------------------------------*
. * 3. Construct firm-level growth measures on-the-fly ----------------*
. *--------------------------------------------------------------------*
. 
. // preserve
. 
.     import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     drop v1

. 
.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

. 
.     gen byte covid = (yh >= 120)

. 
.     /****************************************************************
>     * (a)  Static pre-vs-post difference  – post_covid_growth_we     *
>     ****************************************************************/
.     preserve

.         collapse (mean) total_employees, by(companyname covid)

.         reshape wide total_employees, i(companyname) j(covid)
(j = 0 1)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            8,609   ->   4,371       
Number of variables                   3   ->   3           
j variable (2 values)             covid   ->   (dropped)
xij variables:
                        total_employees   ->   total_employees0 total_employees1
-----------------------------------------------------------------------------

.         gen post_covid_growth_we = (total_employees1 - total_employees0) / total_employees0
(133 missing values generated)

.         winsor2 post_covid_growth_we, cuts(1 99)

.         keep companyname post_covid_growth_we

.                 
.                 xtile tile_growth = post_covid_growth_we, nq(2)

.         tempfile g_static

.         save `g_static'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000006 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (b)  Average post-Covid half-year growth – growth_rate_we_post_c*
>     ****************************************************************/
.     preserve

.         encode companyname, gen(firm_n)

.         xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

.         sort firm_n yh

.         gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
(4,420 missing values generated)

.         winsor2 growth_yh, cuts(1 99) suffix(_we)

.         collapse (mean) growth_yh_we if covid, by(companyname)

.         rename growth_yh_we growth_rate_we_post_c

.                 
.                 xtile tile_post_c = growth_rate_we_post_c, nq(2)

.         tempfile g_postavg

.         save `g_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000008 saved as .dta format

.     restore

. 
.     /****************************************************************
>     * (c)  Dynamic half-year growth – growth_yh_we                   *
>     ****************************************************************/
. //     encode companyname, gen(firm_n)
. //     xtset firm_n yh
. //     sort firm_n yh
. //     gen growth_yh = (total_employees / L.total_employees) - 1 if _n>1
. //     winsor2 growth_yh, cuts(1 99) suffix(_we)
. //     keep companyname yh growth_yh_we
. //     tempfile g_dyn
. //     save `g_dyn'
. 
. // restore   /* → back to user panel */
. 
. *--------------------------------------------------------------------*
. * 4. Merge growth measures into the panel ---------------------------*
. *--------------------------------------------------------------------*
. use `main_panel', clear

. 
. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           229,238  
    -----------------------------------------

. 
. 
. 
. gen var17 = covid*tile_post_c

. gen var18 = covid*tile_post_c*startup

. 
. 
. // reghdfe total_contributions_q100 var3 var5 var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
.         
. //      savefirst
.         
. // reghdfe total_contributions_q100 var3 var5 var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) 
. //      savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
.         
. // ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4 var17 var18, ///
. //     absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
. //
. // reghdfe total_contributions_q100 growth_rate_we_post_c
. 
. *==============================================================*
. *  Post-Covid average growth by industry & MSA  (no nesting)   *
. *==============================================================*
. 
. *------------------------------------------------------------------*
. * 1.  Grab firm → (industry, MSA) keys and stash to `firmkeys'      *
. *------------------------------------------------------------------*
. tempfile firmkeys

. preserve

.     collapse (last) industry (last) company_msa, by(companyname)

.     save `firmkeys'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.000009 saved as .dta format

. restore    // original dataset back in memory

. 
. *------------------------------------------------------------------*
. * 2.  Load head-count history, build fg_we, keep post-Covid rows    *
. *------------------------------------------------------------------*
. import delimited "$processed_data/Scoop_Positions_Firm_Collapse2.csv", clear
(encoding automatically selected: ISO-8859-1)
(6 vars, 323,675 obs)

.     gen date_numeric = date(date, "YMD")

.         drop date

.     rename date_numeric date

.     format date %td

. 
.     gen yh = hofd(date)

.     format yh %th

. 
. 
. 
.         // Drop one-off observations in June 2022
.         drop if date == 22797
(4,345 observations deleted)

. 
. 
.         // Collapse to have one observation per firm-half-year, and calculate growth & rates:
.         collapse (last) total_employees date (sum) join leave, by(companyname yh)

.         
. gen byte covid = (yh >= 120)

. 
. merge m:1 companyname using `firmkeys', nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        27,042
        from master                    27,042  
        from using                          0  

    Matched                            27,133  
    -----------------------------------------

. 
. encode companyname, gen(firm_n)

. xtset firm_n yh

Panel variable: firm_n (unbalanced)
 Time variable: yh, 2016h1 to 2022h1, but with gaps
         Delta: 1 halfyear

. sort firm_n yh

. 
. gen fg = (total_employees/L.total_employees) - 1 if _n>1
(4,420 missing values generated)

. winsor2 fg, cuts(1 99) suffix(_we)

. 
. keep if covid                                  // post-Covid only
(32,544 observations deleted)

. tempfile postcovid

. save `postcovid'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000b saved as .dta format

. 
. *------------------------------------------------------------------*
. * --- Industry leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys industry: egen ind_sum = total(fg_we)

. bys industry: egen ind_N   = count(fg_we)

. gen ind_growth_postavg_lo = (ind_sum - fg_we) / (ind_N - 1) if ind_N > 1
(129 missing values generated)

. // keep companyname yh industry ind_growth_postavg_lo
. collapse (mean) ind_growth_postavg_lo, by(industry)

. tempfile ind_postavg

. save `ind_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000c saved as .dta format

. 
. * --- MSA leave-one-out mean over the whole post-Covid period ---
. use `postcovid', clear

. 
. bys company_msa: egen msa_sum = total(fg_we)

. bys company_msa: egen msa_N   = count(fg_we)

. gen msa_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
(129 missing values generated)

. // keep companyname yh company_msa msa_growth_postavg_lo
. keep company_msa msa_growth_postavg_lo

. collapse (mean) msa_growth_postavg_lo, by(company_msa)

. tempfile msa_postavg

. save `msa_postavg'
file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_92404.00000d saved as .dta format

. 
. 
. // use `postcovid', clear
. // collapse (mean) fg_we, by(companyname)
. // bys companyname: egen msa_sum = total(fg_we)
. // bys companyname: egen msa_N   = count(fg_we)
. // gen comp_growth_postavg_lo = (msa_sum - fg_we) / (msa_N - 1) if msa_N > 1
. // // keep companyname yh company_msa msa_growth_postavg_lo
. // keep companyname comp_growth_postavg_lo
. // tempfile comp_postavg
. // save `comp_postavg'
. 
. 
. *------------------------------------------------------------------*
. * 5.  Attach the two averages back to the firm-half-year panel     *
. *------------------------------------------------------------------*
. use `postcovid', clear                       // back to firm × yh data

. 
. gen companyname_c = lower(companyname)

. 
. 
. merge m:1 industry     using `ind_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 company_msa  using `msa_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_static',   keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname using `g_postavg',  keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,631  
    -----------------------------------------

. merge m:1 companyname_c using `firm_extra', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            17,513  
    -----------------------------------------

. merge m:1 companyname_c using `vacancies'

    Result                      Number of obs
    -----------------------------------------
    Not matched                         3,855
        from master                     3,383  (_merge==1)
        from using                        472  (_merge==2)

    Matched                            14,130  (_merge==3)
    -----------------------------------------

. 
. 
end of do-file

. reghdfe growth_rate_we_post_c ind_growth_postavg_lo msa_growth_postavg_lo tile_rent tile_hhi vacancy_per_hire 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     12,640
Absorbing 1 HDFE group                            F(   5,  12634) =     315.20
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.1109
                                                  Adj R-squared   =     0.1106
                                                  Within R-sq.    =     0.1109
                                                  Root MSE        =     0.0993

---------------------------------------------------------------------------------------
growth_rate_we_post_c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
ind_growth_postavg_lo |   .4535023   .0259196    17.50   0.000     .4026959    .5043087
msa_growth_postavg_lo |   .1260986   .0282408     4.47   0.000     .0707423    .1814549
            tile_rent |   .0502675   .0018713    26.86   0.000     .0465994    .0539355
             tile_hhi |   .0178123   .0018261     9.75   0.000     .0142328    .0213918
     vacancy_per_hire |  -2.92e-06   2.85e-06    -1.03   0.305    -8.50e-06    2.66e-06
                _cons |  -.0958909   .0042254   -22.69   0.000    -.1041733   -.0876086
---------------------------------------------------------------------------------------

. 
. reghdfe growth_rate_we_post_c  vacancy_per_hire 
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =     13,650
Absorbing 1 HDFE group                            F(   1,  13648) =       4.47
                                                  Prob > F        =     0.0345
                                                  R-squared       =     0.0003
                                                  Adj R-squared   =     0.0003
                                                  Within R-sq.    =     0.0003
                                                  Root MSE        =     0.1047

----------------------------------------------------------------------------------
growth_rate_we~c | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-----------------+----------------------------------------------------------------
vacancy_per_hire |  -5.28e-06   2.50e-06    -2.11   0.035    -.0000102   -3.85e-07
           _cons |   .0549062   .0009002    60.99   0.000     .0531417    .0566707
----------------------------------------------------------------------------------

. clear

. exit

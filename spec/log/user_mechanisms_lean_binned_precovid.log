-----------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/saul/Dropbox/Remote Work Startups/main/spec/log/user_mechanisms_lean_binned_precovid.log
  log type:  text
 opened on:  19 Jun 2025, 09:31:15

. 
. // ---------------------------------------------------------------------
. // 1) Globals & dirs
. // ---------------------------------------------------------------------
. do "../src/globals.do"

. global raw_data "../data/raw"

. global processed_data  "../data/processed"

. global results "../results/raw"

. global clean_results "../results/cleaned"

. 
. 
. 
. 
. 
end of do-file

. local result_dir "$results/`specname'"

. cap mkdir "`result_dir'"

. 
. // ---------------------------------------------------------------------
. // 2) Load panel & binarise continuous mechanisms
. // ---------------------------------------------------------------------
. 
. use "$processed_data/user_panel_`panel_variant'.dta", clear

. 
. gen seniority_4 = !inrange(seniority_levels,1,3)

. 
. foreach v in rent hhi_1000 p90_p10_gap {
  2.     capture confirm variable `v'
  3.     if !_rc {
  4.         quietly summarize `v', detail
  5.         scalar med_`v' = r(p50)
  6.         gen `v'_hi = (`v' > med_`v') if !missing(`v')
  7.         replace `v'_hi = . if missing(`v')
  8.         drop `v'
  9.         rename `v'_hi `v'
 10.     }
 11. }
(6,813 missing values generated)
(0 real changes made)
(118 missing values generated)
(0 real changes made)
(0 real changes made)

. 
. // ---------------------------------------------------------------------
. // 3) Interaction variables (lean: only startup split, no teleworkable)
. // ---------------------------------------------------------------------
. 
. gen var8  = covid*rent
(6,813 missing values generated)

. gen var9  = covid*rent*startup
(6,813 missing values generated)

. gen var11 = covid*hhi_1000
(118 missing values generated)

. gen var12 = covid*hhi_1000*startup
(118 missing values generated)

. gen var14 = covid*seniority_4

. gen var15 = covid*seniority_4*startup

. 
. local mech       p90_p10_gap

. local mech_label gap

. 
. gen var17 = covid*`mech'

. gen var18 = covid*`mech'*startup

. 
. // ---------------------------------------------------------------------
. // 4) Postfile & spec definitions (mirroring original lean script)
. // ---------------------------------------------------------------------
. 
. capture postclose handle

. tempfile out

. postfile handle ///
>     str8   model_type  ///
>     str244 spec        ///
>     str40  param       ///
>     double coef se pval pre_mean rkf nobs ///
>     using `out', replace
(file /var/folders/hg/s3xm9w393gxby64_zklmhgbc0000gn/T//S_97664.000001 not found)

. 
. local specs ///
>   "baseline" ///
>   "rent" "hhi" "seniority" "`mech_label'" ///
>   "rent_hhi" "rent_seniority" "rent_`mech_label'" "hhi_seniority" "hhi_`mech_label'" "seniority_`mech_label'" ///
>   "rent_hhi_seniority" "rent_hhi_`mech_label'" "rent_seniority_`mech_label'" "hhi_seniority_`mech_label'" ///
>   "rent_hhi_seniority_`mech_label'"

. 
. // --- Spec matrices (lean: instruments are always var6 var7) -------------
. 
. // Startup dummy included via var9/12/15/18 where relevant
. 
. //  1) baseline
. local spec_ols_exog1  var4

. local spec_iv_exog1   var4

. local spec_instr1     var6 var7

. local spec_endo1      var3 var5

. 
. //  2) rent
. local spec_ols_exog2  var4 var8 var9

. local spec_iv_exog2   var4 var8 var9

. local spec_instr2     var6 var7

. local spec_endo2      var3 var5

. 
. //  3) hhi
. local spec_ols_exog3  var4 var11 var12

. local spec_iv_exog3   var4 var11 var12

. local spec_instr3     var6 var7

. local spec_endo3      var3 var5

. 
. //  4) seniority
. local spec_ols_exog4  var4 var14 var15

. local spec_iv_exog4   var4 var14 var15

. local spec_instr4     var6 var7

. local spec_endo4      var3 var5

. 
. //  5) `mech'
. local spec_ols_exog5  var4 var17 var18

. local spec_iv_exog5   var4 var17 var18

. local spec_instr5     var6 var7

. local spec_endo5      var3 var5

. 
. //  6) rent_hhi
. local spec_ols_exog6  var4 var8 var9 var11 var12

. local spec_iv_exog6   var4 var8 var9 var11 var12

. local spec_instr6     var6 var7

. local spec_endo6      var3 var5

. 
. //  7) rent_seniority
. local spec_ols_exog7  var4 var8 var9 var14 var15

. local spec_iv_exog7   var4 var8 var9 var14 var15

. local spec_instr7     var6 var7

. local spec_endo7      var3 var5

. 
. //  8) rent_`mech'
. local spec_ols_exog8  var4 var8 var9 var17 var18

. local spec_iv_exog8   var4 var8 var9 var17 var18

. local spec_instr8     var6 var7

. local spec_endo8      var3 var5

. 
. //  9) hhi_seniority
. local spec_ols_exog9  var4 var11 var12 var14 var15

. local spec_iv_exog9   var4 var11 var12 var14 var15

. local spec_instr9     var6 var7

. local spec_endo9      var3 var5

. 
. // 10) hhi_`mech'
. local spec_ols_exog10 var4 var11 var12 var17 var18

. local spec_iv_exog10  var4 var11 var12 var17 var18

. local spec_instr10    var6 var7

. local spec_endo10     var3 var5

. 
. // 11) `mech'_seniority
. local spec_ols_exog11 var4 var17 var18 var14 var15

. local spec_iv_exog11  var4 var17 var18 var14 var15

. local spec_instr11    var6 var7

. local spec_endo11     var3 var5

. 
. // 12) rent_hhi_seniority
. local spec_ols_exog12 var4 var8 var9 var11 var12 var14 var15

. local spec_iv_exog12  var4 var8 var9 var11 var12 var14 var15

. local spec_instr12    var6 var7

. local spec_endo12     var3 var5

. 
. // 13) rent_hhi_`mech'
. local spec_ols_exog13 var4 var8 var9 var11 var12 var17 var18

. local spec_iv_exog13  var4 var8 var9 var11 var12 var17 var18

. local spec_instr13    var6 var7

. local spec_endo13     var3 var5

. 
. // 14) rent_seniority_`mech'
. local spec_ols_exog14 var4 var8 var9 var14 var15 var17 var18

. local spec_iv_exog14  var4 var8 var9 var14 var15 var17 var18

. local spec_instr14    var6 var7

. local spec_endo14     var3 var5

. 
. // 15) hhi_seniority_`mech'
. local spec_ols_exog15 var4 var11 var12 var14 var15 var17 var18

. local spec_iv_exog15  var4 var11 var12 var14 var15 var17 var18

. local spec_instr15    var6 var7

. local spec_endo15     var3 var5

. 
. // 16) rent_hhi_seniority_`mech'
. local spec_ols_exog16 var4 var8 var9 var11 var12 var14 var15 var17 var18

. local spec_iv_exog16  var4 var8 var9 var11 var12 var14 var15 var17 var18

. local spec_instr16    var6 var7

. local spec_endo16     var3 var5

. 
. // ---------------------------------------------------------------------
. // 5) Run baseline + loop (OLS & IV) ----------------------------------
. // ---------------------------------------------------------------------
. 
. display as text "→ Spec 1: baseline (full sample)"
→ Spec 1: baseline (full sample)

. summarize total_contributions_q100 if covid == 0, meanonly

. local pre_mean = r(mean)

. 
. reghdfe total_contributions_q100 var3 var5 var4, absorb(firm_id#user_id yh) vce(cluster user_id)
(dropped 6597 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    224,708
Absorbing 2 HDFE groups                           F(   3,  35478) =      16.65
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7186
                                                  Adj R-squared   =     0.6525
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,479         Root MSE        =    17.6444

                           (Std. err. adjusted for 35,479 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.234691   .4958927    -2.49   0.013    -2.206656   -.2627261
        var5 |   6.208444   1.270913     4.89   0.000     3.717416    8.699472
        var4 |  -6.711066   1.096609    -6.12   0.000    -8.860454   -4.561678
       _cons |   50.52317   .1507992   335.04   0.000      50.2276    50.81874
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42710       42710           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. local N = e(N)

. foreach p in var3 var5 {
  2.     post handle ("OLS") ("baseline") ("`p'") (_b[`p']) (_se[`p']) (2*ttail(e(df_r),abs(_b[`p']/_se[`p']))) (`pre_mean') (.) (`N')
  3. }

. 
. ivreghdfe total_contributions_q100 (var3 var5 = var6 var7) var4, absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
(dropped 6597 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          3  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          3  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   35479                Number of obs =   224708
                                                      F(  3, 35478) =    10.55
                                                      Prob > F      =   0.0000
Total (centered) SS     =  56688987.29                Centered R2   =  -0.0026
Total (uncentered) SS   =  56688987.29                Uncentered R2 =  -0.0026
Residual SS             =   56837758.2                Root MSE      =     15.9

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -9.263295   4.013595    -2.31   0.021    -17.13006   -1.396526
        var5 |   12.45296   5.392867     2.31   0.021     1.882779    23.02315
        var4 |  -10.43373   4.045733    -2.58   0.010    -18.36349   -2.503968
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            231.086
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1854.151
                         (Kleibergen-Paap rk Wald F statistic):        123.431
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42710       42710           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. local rkf = e(rkf)

. local N = e(N)

. foreach p in var3 var5 {
  2.     post handle ("IV") ("baseline") ("`p'") (_b[`p']) (_se[`p']) (2*ttail(e(df_r),abs(_b[`p']/_se[`p']))) (`pre_mean') (`rkf') (`N')
  3. }

. 
. // Loop specs 2-16
. forvalues i = 2/16 {
  2.     local spec : word `i' of `specs'
  3.     local ols_exog "`spec_ols_exog`i''"
  4.     local iv_exog  "`spec_iv_exog`i''"
  5.     local instr    "`spec_instr`i''"
  6.     local endo     "`spec_endo`i''"
  7. 
.     display as text "→ Spec `i': `spec'"
  8.     summarize total_contributions_q100 if covid == 0, meanonly
  9.     local pre_mean = r(mean)
 10. 
.     reghdfe total_contributions_q100 var3 var5 `ols_exog', absorb(firm_id#user_id yh) vce(cluster user_id)
 11.     local N = e(N)
 12.     foreach p in var3 var5 {
 13.         post handle ("OLS") ("`spec'") ("`p'") (_b[`p']) (_se[`p']) (2*ttail(e(df_r),abs(_b[`p']/_se[`p']))) (`pre_mean') (.) (`N')
 14.     }
 15. 
.     ivreghdfe total_contributions_q100 (`endo' = `instr') `iv_exog', absorb(firm_id#user_id yh) vce(cluster user_id) savefirst
 16.     local rkf = e(rkf)
 17.     local N = e(N)
 18.     foreach p in var3 var5 {
 19.         post handle ("IV") ("`spec'") ("`p'") (_b[`p']) (_se[`p']) (2*ttail(e(df_r),abs(_b[`p']/_se[`p']))) (`pre_mean') (`rkf') (`N
> ')
 20.     }
 21. }
→ Spec 2: rent
(dropped 6380 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    218,112
Absorbing 2 HDFE groups                           F(   5,  34563) =      11.07
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7190
                                                  Adj R-squared   =     0.6532
                                                  Within R-sq.    =     0.0007
Number of clusters (user_id) =     34,564         Root MSE        =    17.6268

                           (Std. err. adjusted for 34,564 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -.9264597   .5138312    -1.80   0.071    -1.933586    .0806662
        var5 |   4.011273   1.256332     3.19   0.001     1.548821    6.473725
        var4 |  -5.358447   1.151345    -4.65   0.000    -7.615121   -3.101774
        var8 |  -1.368525   .3120102    -4.39   0.000    -1.980076   -.7569753
        var9 |   1.379171   .7321657     1.88   0.060     -.055898    2.814239
       _cons |   50.71049   .1558651   325.35   0.000     50.40499    51.01599
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     41412       41412           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
(dropped 6380 singleton observations)
(MWFE estimator converged in 8 iterations)

Stored estimation results
-------------------------
---------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+-------------------------------------------------------------
_ivreg2_var3 | ivreg2         var3          5  First-stage regression: var3
_ivreg2_var5 | ivreg2         var5          5  First-stage regression: var5
---------------------------------------------------------------------------

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on user_id

Number of clusters (user_id) =   34564                Number of obs =   218112
                                                      F(  5, 34563) =     9.19
                                                      Prob > F      =   0.0000
Total (centered) SS     =     54932284                Centered R2   =  -0.0021
Total (uncentered) SS   =     54932284                Uncentered R2 =  -0.0021
Residual SS             =  55047154.97                Root MSE      =    15.89

------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -8.491457    5.28165    -1.61   0.108    -18.84366     1.86075
        var5 |    10.9058   6.475241     1.68   0.092    -1.785885    23.59748
        var4 |  -9.393638   4.561084    -2.06   0.039    -18.33351   -.4537637
        var8 |  -.6137846   .6109632    -1.00   0.315    -1.811292    .5837232
        var9 |   .6364922   .8989567     0.71   0.479    -1.125492    2.398477
------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            131.086
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1099.092
                         (Kleibergen-Paap rk Wald F statistic):         68.318
Stock-Yogo weak ID test critical values: 10% maximal IV size              7.03
                                         15% maximal IV size              4.58
                                         20% maximal IV size              3.95
                                         25% maximal IV size              3.63
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):         0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         var3 var5
Included instruments: var4 var8 var9
Excluded instruments: var6 var7
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     41412       41412           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
→ Spec 3: hhi
(dropped 6591 singleton observations)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =    224,596
Absorbing 2 HDFE groups                           F(   5,  35468) =      11.19
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7185
                                                  Adj R-squared   =     0.6524
                                                  Within R-sq.    =     0.0006
Number of clusters (user_id) =     35,469         Root MSE        =    17.6442

                           (Std. err. adjusted for 35,469 clusters in user_id)
------------------------------------------------------------------------------
             |               Robust
total_co~100 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        var3 |  -1.283484   .4958602    -2.59   0.010    -2.255385   -.3115825
        var5 |   6.223611   1.271595     4.89   0.000     3.731244    8.715977
        var4 |  -7.594319   1.207974    -6.29   0.000    -9.961985   -5.226653
       var11 |   -.617106   .3010429    -2.05   0.040    -1.207159   -.0270526
       var12 |   1.439591   .7127425     2.02   0.043     .0425934    2.836588
       _cons |   50.66404   .1649669   307.12   0.000      50.3407    50.98738
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------------+
       Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------------+---------------------------------------|
   firm_id#user_id |     42681       42681           0    *|
                yh |        11           1          10     |
-----------------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation
(dropped 6591 singleton observations)
(MWFE estimator converged in 8 iterations)
--Break--
r(1);

end of do-file

--Break--
r(1);

. do "/Users/saul/Dropbox/Remote Work Startups/main/src/build_all_user_panels.do"

. /*-------------------------------------------------------------------
> | build_user_panel.do — Generate user-level panel datasets
> | Author : <your-name>
> | Updated: 06 Jun 2025
> |
> | DESCRIPTION
> | ----------
> | Re-runs the *original* cleaning / merging pipeline **unchanged**, then
> | branches into three sample variants **without touching any other
> | logic**:
> |   • unbalanced – full cleaned panel (default)
> |   • balanced   – users observed in *every* half-year between the
> |                  global min & max yh
> |   • precovid   – users with positive pre-COVID restricted contributions
> |
> # NOTE ──────────────────────────────────────────────────────────────────
> # In earlier versions the *pre-COVID* (“precovid”) sample was silently
> # duplicated to the generic legacy filenames `user_panel.dta/csv`.  This
> # implicit fallback made it impossible to see at a glance which panel
> # variant later specification scripts had been run on.
> #
> # The compatibility artefact has now been **removed**: every output file
> # is written *only* under an explicit, self-describing filename of the
> # form `user_panel_<variant>.dta|csv` (e.g. `user_panel_unbalanced.dta`).
> # Down-stream code must therefore always reference the panel variant
> # explicitly in filenames (e.g. by passing it as an argument to
> # specification scripts).  No more silent defaults.
> |
> | USAGE
> | -----
> |   do build_user_panel.do
> |   *Optionally* edit `local sample_types` to generate a subset.
> *-------------------------------------------------------------------*/
. 
. capture log close
